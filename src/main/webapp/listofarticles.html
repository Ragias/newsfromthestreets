<div id="main" class="lift:surround?with=default&at=content">

	<h2>List of Articles</h2>
	<div id="map_canvas" style="width: 500px; height: 300px"></div>

	<script type="text/javascript">
		function initialize() {
			var mapOptions = {
				center : new google.maps.LatLng(-34.397, 150.644),
				zoom : 8,
				mapTypeId : google.maps.MapTypeId.ROADMAP
			};
			var map = new google.maps.Map(document.getElementById("map_canvas"), mapOptions);
			$(document).ready(function() {
				var oldDateStr = "";
				var oldCategoryStr = "";
				var markerArr = new Array();

				var dateStr = "";
				var categoryStr = "";

				function isChanged() {
					if (oldDateStr == dateStr && oldCategoryStr == categoryStr) {
						return false;
					} else {
						return true;
					}
				}

				(function() {
					if (isChanged()) {
						console.log(oldDateStr + " == " + dateStr + " " + oldCategoryStr + " == " + categoryStr)

						if (!markerArr.isEmpty) {
							while (markerArr[0]) {
								markerArr.pop().setMap(null);
							}
						}
						oldDateStr = dateStr
						oldCategoryStr = categoryStr
					}

					dateStr = $("#the_date option:selected").text();
					categoryStr = $("#the_category option:selected").text();
					if (dateStr == "") {
						dateStr = "All";
					}
					if (categoryStr == "") {
						categoryStr = "All";
					}
					$.getJSON("/api/newsfromthestreets/articles/" + categoryStr + "/" + dateStr, function(json) {

						if (json.length > 0) {
							for ( i = 0; i < json.length; i++) {
								var location = json[i];
								addMarker(location);
							}
						}
					});
					setTimeout(arguments.callee, 1000);
				})();

				function addMarker(location) {

					var check = false;
					for ( i = 0; i < markerArr.length; i++) {
						//console.log(markerArr[i].title + " " + location.title + " " + markerArr.length)
						if (markerArr[i].title == location.title) {
							check = true;

							if (location.lat == markerArr[i].position.lat() && location.lng == markerArr[i].position.lng()) {
								break;
							}
							var point = new google.maps.LatLng(location.lat, location.lng);

							var marker = new google.maps.Marker({
								position : point,
								map : map,
								title : location.title,
								icon : 'images/beachflag.png'
							});
							markerArr[i].setMap(null)
							markerArr[i] = marker;
							break;
						}
					}
					if (!check) {
						console.log(location.title)
						var point = new google.maps.LatLng(location.lat, location.lng);

						var marker = new google.maps.Marker({
							position : point,
							map : map,
							title : location.title,
							icon : 'images/beachflag.png'
						});
						markerArr.push(marker);
					}

				};
			});

		}

	</script>

	<div>
		<div class="lift:ListOfArticles">
			Category:
			<select name="category" id="the_category"></select>
			<br/>
			Date:
			<select name="date" id="the_date"></select>
			<br/>
			<input name="submit" type="submit" value="Submit">
			</input>
		</div>
	</div>
	<div>
		<span>List Of Articles</span><ul id="listOfArticles"></ul>
	</div>

</div>